---
layout:     post
title:      浏览器HTTP协议缓存机制
subtitle:   
date:       2018-05-29
author:     worldly
header-img: img/post-bg-flower-4.jpg
catalog: true
tags:
    - HTTP
---


### 前言
Web开发，浏览器的重要性不言而喻。一直对浏览器的缓存机制存在困惑，诸多资料讲解的繁琐冗余，各种HTTP字段搞得人晕头转向，不便于理解。其实浏览器缓存最主要抓住两种策略：强制缓存和对比缓存。每种缓存策略下所使用的首部字段不同，辅之以流程图就好理解了。

![](http://dev.fenzhitech.com/res/aa0fa6367609598c2ada54bcf1e3ca65.png)

#### 一、浏览器缓存策略

##### 1、浏览器第一次请求流程图

![](http://dev.fenzhitech.com/res/c6bf67a7c8f8d2d5380c1b601335b887.png)

##### 2、浏览器第二次请求流程图

![](http://dev.fenzhitech.com/res/2fd57b5e941b9e9aaf8432a1e1224a58.png)

简单来讲分以下几个主要流程:
* 检查是否有缓存：
  * 先看Cache-Control字段值，如果值设定为Public、Private、no-cache、max-age 中的任意一种，表明响应内容可以被客户端存储
* 辨别缓存内容是否过期
  * 查看Cache-Control字段和Expires字段，其中Cache-Control字段的优先级高于Expires
  * 如果存在Cache-Control字段，其 no-cache 相当于 max-age = 0    

**重点：如果缓存内容没有过期，则采用强制缓存策略，客户端则直接从本地缓存数据中获取，对应显示200(from cache)**

 * 对比过期时间与实体标签
    * 客户端检测到缓存过期或浏览器刷新后，再次向服务器发出一次请求
    * 如果资源具有 Last-modified 声明，则带上 If-Modified-since 首部字段将文件最后修改时间传给服务器，与之比对文件最后的修改时间。如果文件最后的修改时间较新，则服务器返回 200 ，重新返回最新的资源，否则返回304，告知从浏览器缓存中读取
    * 如果资源具有 Etag 声明，则带上 If-None-Match 首部字段将文件唯一标识传给服务器，与之比对文件的唯一标识。如果表识对不上，则服务器返回 200 ，重新返回最新的资源，否则返回304，告知从浏览器缓存中读取

**重点：如果缓存内容过期，则采取对比缓存策略，服务器对比文件修改的时间，从而决定从哪获取资源**  

#### 二、缓存常用字段

##### 1、Cache-control

当你在浏览器中输入URL后，你使用的电脑会发出一个DNS请求（将域名转化为IP地址的请求）。对于浏览器，实际上并不知道"https://www.liyangspace.cn" 到底是什么东西，需要确认其中域名所在服务器的IP地址才能找到目标网站（浏览器需要对IP地址进行识别，才能够进一步传递网址和信息内容）。那么，将域名解析成对应的服务器IP地址这项工作，就是由DNS服务器来完成。


 字段值       | 说明
 ----------- | -----------------
 Public      | 所有内容都将被缓存(客户端和代理服务器都可缓存)
 Private     | 内容只缓存到私有缓存中(仅客户端可以缓存，代理服务器不可缓存)     
 no-cache    | 必须先与服务器确认返回的响应是否被更改，然后才能使用该响应来满足后续对同一个网址的请求。因此，如果存在合适的验证令牌 (ETag)，no-cache 会发起往返通信来验证缓存的响应，如果资源未被更改，可以避免下载
 max-age     | 缓存的内容将在 xxx 秒后失效
 no-store    | 所有内容都不会被缓存到缓存或 Internet 临时文件中


##### 2、Etag

Etag为 HTTP1.1 新增的首部字段，其为资源在服务器端的唯一标识符，其相对于 Last-modified 字段，能够避免其只能精确到秒级的尴尬

##### 3、Last-modified
Last-modified 为 HTTP1.0 字段，其为服务器在响应请求时告诉客户端资源最后的修改时间

##### 4、Expires
Expires为HTTP1.0 字段，其值表示为服务端返回的资源到期时间。因客户端跟服务端时间不一致，存在误差
